{% extends 'base.html' %}
{% load static %}

{% block title %}Home - CharmAway{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/home.css' %}?v=202501231730">

<!-- Hero Carousel Section -->
<section class="hero-carousel slide-1">
    <div class="carousel-container">
        <div class="carousel-track">
            <div class="carousel-slide active">
                <div class="slide-content">
                    <div class="slide-text">
                        <h1>Descubre tu belleza natural</h1>
                        <p>Los mejores productos de cosmética para ti</p>
                        <a href="{% url 'catalog:catalog' %}" class="btn-primary">Explorar Catálogo</a>
                    </div>
                    <div class="slide-image">
                        <div class="image-gradient-container">
                            {% if featured_products %}
                            <img src="{{ featured_products.0.images.all.0.image }}" alt="{{ featured_products.0.name }}" class="hero-product-image" onerror="this.style.display='none';">
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</section>

<!-- Departments Section -->
<section class="categories-section">
    <div class="container">
        <h2 class="section-title">Explora por departamento</h2>
        <div class="categories-carousel-wrapper">
            <div class="categories-carousel" id="categoriesCarousel">
                {% for department in departments %}
                <a href="{% url 'catalog:catalog' %}?department={{ department.id }}" class="category-card">
                    <div class="category-icon">
                        {% if department.image %}
                        <img src="{{ department.image }}" alt="{{ department.name }}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        {% endif %}
                        <div class="category-placeholder" {% if department.image %}style="display:none;"{% endif %}>
                            <svg width="60" height="60" viewBox="0 0 24 24" fill="none">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5"/>
                                <path d="M12 8v8M8 12h8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            </svg>
                        </div>
                    </div>
                    <h3>{{ department.name }}</h3>
                </a>
                {% empty %}
                <p class="no-content">No hay departamentos disponibles.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</section>

<!-- Featured Products Section -->
{% if featured_products %}
<section class="featured-section">
    <div class="container">
        <div class="section-header">
            <h2 class="section-title">Productos destacados</h2>
            <a href="{% url 'catalog:catalog' %}" class="view-all">Ver todos</a>
        </div>
        <div class="products-grid">
            {% for product in featured_products %}
            <article class="product-card">
                <a href="{% url 'catalog:product_detail' product.id %}" class="product-link">
                    <div class="product-image-wrapper">
                        {% with main_image=product.images.all|first %}
                        {% if main_image %}
                        <img src="{{ main_image.image }}" alt="{{ product.name }}" class="product-image"
                             onerror="this.onerror=null; this.src='{% static 'images/no-image.svg' %}'; this.style.objectFit='contain'; this.style.padding='2rem';">
                        {% else %}
                        <img src="{% static 'images/no-image.svg' %}" alt="Sin imagen" class="product-image"
                             style="object-fit: contain; padding: 2rem;">
                        {% endif %}
                        {% endwith %}
                    </div>

                    <div class="product-info">
                        {% if product.brand %}
                        <p class="product-brand">{{ product.brand.name }}</p>
                        {% endif %}

                        <h3 class="product-name">{{ product.name }}</h3>

                        {% if product.category %}
                        <p class="product-category">{{ product.category.name }}</p>
                        {% endif %}

                        <div class="product-pricing">
                            {% if product.offer_price %}
                            <span class="product-price original-price">{{ product.price }} €</span>
                            <span class="product-price offer-price">{{ product.offer_price }} €</span>
                            {% else %}
                            <span class="product-price">{{ product.price }} €</span>
                            {% endif %}
                        </div>

                        {% if product.stock > 0 %}
                        <p class="product-stock in-stock">En stock: {{ product.stock }} unidades</p>
                        {% else %}
                        <p class="product-stock out-of-stock">Agotado</p>
                        {% endif %}
                    </div>
                </a>

                <div class="product-actions-wrapper">
                    <input type="number" id="quantity-{{ product.id }}" value="1" min="1" max="{{ product.stock }}" class="qty-input-card">
                    <a href="#" onclick="event.preventDefault(); buyNow({{ product.id }});"
                        class="btn-quick-buy"
                        {% if product.stock <= 0 %}style="opacity:0.5; cursor:not-allowed; pointer-events:none;"{% endif %}>
                        Compra rápida
                    </a>
                </div>

                <form action="{% url 'add_product' product.id %}" method="post" id="form-add-{{ product.id }}">
                    {% csrf_token %}
                    <input type="hidden" name="quantity" id="quantity-hidden-{{ product.id }}" value="1">
                    <button type="submit"
                            class="btn-add-cart"
                            {% if product.stock <= 0 %}disabled style="opacity:0.5; cursor:not-allowed;"{% endif %}>
                        Añadir al carro
                    </button>
                </form>
            </article>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<script>
function buyNow(productId) {
    const quantity = document.getElementById('quantity-' + productId).value;
    fetch('/order/buy-now/product/' + productId + '/?quantity=' + quantity)
        .then(() => {
            window.location.href = '/order/cart/checkout/';
        })
        .catch(error => console.error(error));
}

// Sincronizar el input con el hidden input y validar stock
document.addEventListener('DOMContentLoaded', function() {
    const qtyInputs = document.querySelectorAll('.qty-input-card');
    qtyInputs.forEach(function(input) {
        input.addEventListener('input', function() {
            const productId = this.id.replace('quantity-', '');
            const hiddenInput = document.getElementById('quantity-hidden-' + productId);

            // Eliminar cualquier caracter que no sea número
            this.value = this.value.replace(/[^0-9]/g, '');

            const max = parseInt(this.getAttribute('max'));
            const min = parseInt(this.getAttribute('min')) || 1;

            // Si el campo está vacío, establecer en 1
            if (this.value === '' || parseInt(this.value) < min) {
                this.value = min.toString();
            }

            // Si excede el máximo, establecer al máximo
            if (parseInt(this.value) > max) {
                this.value = max.toString();
            }

            hiddenInput.value = this.value;
        });

        input.addEventListener('blur', function() {
            const productId = this.id.replace('quantity-', '');
            const hiddenInput = document.getElementById('quantity-hidden-' + productId);
            const min = parseInt(this.getAttribute('min')) || 1;

            // Al perder el foco, asegurar que tenga al menos el valor mínimo
            if (this.value === '' || parseInt(this.value) < min) {
                this.value = min.toString();
            }

            hiddenInput.value = this.value;
        });
    });
});
</script>
{% endblock %}

{% block footer %}
<div class="copyright-footer">
    &copy; 2025 Charmaway. Todos los derechos reservados.
</div>
{% endblock %}